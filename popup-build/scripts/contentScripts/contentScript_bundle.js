class K{constructor(){this.handlers={}}publish(t,s){this.handlers[t]!==void 0&&this.handlers[t].forEach(i=>{i(s)})}subscribe(t,s){this.handlers[t]===void 0&&(this.handlers[t]=[]),this.handlers[t].push(s)}unsubscribe(t,s){this.handlers[t]=this.handlers[t].filter(i=>i!==s)}}const n=new K;let F,B,w,S;const z=()=>w,C=()=>S,k=()=>{w=window.innerHeight,S=window.innerWidth},R=()=>{F=w,B=S},A=()=>{n.publish("windowResized",{windowWidth:S,windowHeight:w,windowWidthPrev:B,windowHeightPrev:F})},Q=()=>{R(),k(),A()};n.subscribe("canvasAndBlizzardReady",()=>{window.addEventListener("resize",Q)});k();R();A();let E,I;const _=()=>{n.publish("newMouseShiftCoef",I)},ee=({clientX:e})=>{I=e/E-1},P=({windowWidth:e})=>{E=e/2},te=e=>{ee(e),_()};P({windowWidth:C()});window.addEventListener("mousemove",te);n.subscribe("windowResized",P);class se{constructor({fps:t=60,callback:s,tolerance:i=.1}){this.requestID=0,this.fps=t,this.callback=s,this.interval=1e3/this.fps-i}start(){let t=performance.now();const s=i=>{this.requestID=requestAnimationFrame(s);const a=i-t;a>=this.interval&&(t=i-a%this.interval,this.callback(a))};this.requestID=requestAnimationFrame(s)}stop(){cancelAnimationFrame(this.requestID)}}const ne=document.body,ie=2*Math.PI;let o,l,v,d;const oe=()=>{o=document.createElement("canvas")},le=()=>{o.style.height="100%",o.style.width="100%",o.style.backgroundColor="transparent",o.style.position="fixed",o.style.top="0px",o.style.left="0px",o.style.pointerEvents="none"},ae=()=>{l=o.getContext("2d")},T=({windowWidth:e,windowHeight:t})=>{o.height=t,o.width=e},re=()=>{ne.append(o)},W=e=>{v=e},y=()=>{l.fillStyle=v},D=e=>{W(e),y()},g=({x:e,y:t,radius:s})=>{l.beginPath(),l.arc(e,t,s,0,ie)},b=e=>{switch(e){case"static":{d=ce();break}case"dynamic":{d=de();break}default:throw`unknown canvas fill mode - ${e}`}},ce=()=>(D(v),()=>{l.fill()}),de=()=>e=>{l.fillStyle=e,l.fill()},L=()=>{l.clearRect(0,0,o.width,o.height)},X=e=>{e?o.style.zIndex="99999":o.style.zIndex="-1"},ue=({fillColor:e,windowWidth:t,windowHeight:s,onTop:i,fillMode:a})=>{oe(),ae(),le(),T({windowWidth:t,windowHeight:s}),X(i),re(),W(e),y(),b(a)},he=({windowWidth:e,windowHeight:t})=>{T({windowWidth:e,windowHeight:t}),y()};n.subscribe("windowResized",he);const Y=new Set,M=e=>{Y.add(e)},fe=()=>{L(),Y.forEach(e=>{e()})},H=new se({fps:60,callback:fe}),we=()=>{H.start()},Se=()=>{H.stop()};n.subscribe("startCanvasRender",we);n.subscribe("stopCanvasRender",Se);class V{}const r=(e,t)=>Math.floor(Math.random()*(t-e)+e),Ce=()=>"#"+Math.floor(Math.random()*16581375).toString(16).padEnd(6,"0"),pe=Math.min(screen.availHeight,screen.availWidth),be=3,u=e=>Number((pe*e/100).toFixed(be)),O=-200,me=200;let m=0;const ze=e=>{m=me*e*-1};n.subscribe("newMouseShiftCoef",ze);const q=u(.24),G=u(.375),ve=q,ye=G,ge=u(.625),Me=u(1.875),x=u(.00125),xe=2e3,Oe=2e3;class Z extends V{reInit(){this.getColor(),this.resetRadius(),this.getPos(),this.getStep(),this.getGravityCoef(),this.startFallAndGrow()}getColor(){this.color=Ce()}getPos(){this.x=this.randomXPos(),this.y=this.randomYPos()}getStep(){this.step=r(ve,ye)}getGravityCoef(){this.yStepCoef=r(ge,Me)/10}resetRadius(){this.radius=0}randomXPos(){return r(m,C()+m)}randomYPos(){return r(O,z()+O)}fallAndGrow(){this.grow(),this.radius>=this.fullRadius&&this.justFall(),this.nextStep()}fall(){this.nextStep()}startFallAndGrow(){this.move=this.fallAndGrow}justFall(){this.move=this.fall}grow(){this.radius+=x}nextStep(){this.x+=this.step*this.xStepCoef,this.y+=this.step*this.yStepCoef}setDirectionCoef(t){this.xStepCoef=t}}class Fe{static create(){const t=new Z;return t.xStepCoef=0,t.fullRadius=r(q,G),t.radiusHalf=Math.floor(t.fullRadius/2),t.reInit(),t}}let h;const $=e=>e.y>=z()-e.radiusHalf,Be=e=>e.x>=C(),ke=e=>e.x<=-e.radius,Re=e=>{const t=$(e);return Be(e)||t?{isFallen:!0,isFallenByY:t}:{isFallen:!1}},Ae=e=>{const t=$(e);return ke(e)||t?{isFallen:!0,isFallenByY:t}:{isFallen:!1}},j=e=>{e>=0?h=Re:h=Ae};n.subscribe("newMouseShiftCoef",j);j(0);let N=0,c=new Set;const Ee=e=>{const t=e-c.size;t>0?U(t):t<0&&Pe(Math.abs(t))},Ie=e=>{N=e,c.forEach(t=>{t.setDirectionCoef(e)})},U=e=>{let t;for(let s=0;s<e;s+=1)t=Fe.create(),c.add(t),t.setDirectionCoef(N)},Pe=e=>{const t=c.values();let s;for(let i=0;i<e;i+=1)s=t.next().value,c.delete(s),n.publish("newFlyingMeltingSnowflake",s)},Te=()=>{c.forEach(e=>{e.move();const t=h(e);t.isFallen&&t.isFallenByY&&n.publish("newMeltingSnowflake",e),t.isFallen&&e.reInit(),g(e),d(e.color)})};n.subscribe("newMouseShiftCoef",Ie);n.subscribe("newBlizzard",U);n.subscribe("newBlizzardSize",Ee);M(Te);const We=()=>{n.publish("initCanvasAndBlizzard",()=>{n.publish("startCanvasRender")})};chrome.storage.local.get({snowfallEnable:!0},e=>{if(!e.snowfallEnable){n.publish("initCanvasAndBlizzard");return}document.readyState==="complete"?n.publish("initCanvasAndBlizzard",()=>{n.publish("startCanvasRender")}):window.addEventListener("load",We,{once:!0})});const De=e=>{e?n.publish("startCanvasRender"):(n.publish("stopCanvasRender"),L())},Le=e=>{n.publish("newBlizzardSize",e)};chrome.storage.onChanged.addListener(e=>{"snowfallEnable"in e?De(e.snowfallEnable.newValue):"snowfallCount"in e?Le(e.snowfallCount.newValue):"snowfallColor"in e?D(e.snowfallColor.newValue):"snowfallZtop"in e?X(e.snowfallZtop.newValue):"snowfallColorMode"in e&&(e.snowfallColorMode.newValue==="dynamic"?b("dynamic"):b("static"))});{const e=(t=()=>{})=>{chrome.storage.local.get({snowfallCount:100,snowfallColor:"#ff11ff",snowfallZtop:!1,snowfallColorMode:"static"},s=>{ue({fillColor:s.snowfallColor,onTop:s.snowfallZtop,windowWidth:C(),windowHeight:z(),fillMode:s.snowfallColorMode}),n.publish("newBlizzard",s.snowfallCount),t(),n.publish("canvasAndBlizzardReady")})};n.subscribe("initCanvasAndBlizzard",e)}class Xe extends V{constructor({x:t,y:s,radius:i,color:a}){super(),this.startMelt=()=>{this.melt=this.meltingStep},this.melt=this.noMeltingStep,this.x=t,this.y=s,this.radius=i,this.color=a,this.meltTimeS=r(xe,Oe),setTimeout(this.startMelt,this.meltTimeS)}noMeltingStep(){}meltingStep(){this.radius-=x}}let f=new Set;const J=()=>f,Ye=e=>{const t=new Xe(e);f.add(t)},He=()=>{f.forEach(e=>{e.melt(),Ve(e)?f.delete(e):(g(e),d(e.color))})},Ve=e=>e.radius<=0;n.subscribe("newMeltingSnowflake",Ye);M(He);class qe extends Z{constructor(t){super(),this.init(t)}init(t){this.x=t.x,this.y=t.y,this.radius=t.radius,this.yStepCoef=t.yStepCoef,this.xStepCoef=t.xStepCoef,this.step=t.step,this.color=t.color}melt(){this.radius-=x}fallAndMelt(){this.melt(),this.nextStep()}}let p=new Set;const Ge=e=>{p.forEach(t=>{t.setDirectionCoef(e)})},Ze=e=>{p.add(new qe(e))},$e=e=>{p.delete(e)},je=()=>{p.forEach(e=>{e.fallAndMelt();const t=Ne(e),s=h(e);t||s.isFallen?$e(e):(g(e),d(e.color))})},Ne=e=>e.radius<=0;n.subscribe("newFlyingMeltingSnowflake",Ze);n.subscribe("newMouseShiftCoef",Ge);M(je);const Ue=({windowWidth:e,windowHeight:t,windowWidthPrev:s,windowHeightPrev:i})=>{e<s&&Je(e),i!==t&&Ke(t)},Je=e=>{const t=J();t.forEach(s=>{s.x>e&&t.delete(s)})},Ke=e=>{J().forEach(s=>{s.y=e-s.radius/2})};n.subscribe("windowResized",Ue);
